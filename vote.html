<!DOCTYPE html>
<html lang="ja">
<head>

<title>住民投票</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="firebase.js"></script>
</head>
<body>
<header><h1>住民投票</h1></header>

<div class="container section" id="loginDiv">
  <h2>住民番号でログイン</h2>
  <input type="text" id="residentIdInput" placeholder="住民番号">
  <button onclick="login()">ログイン</button>
</div>

<div class="container section" id="voteDiv" style="display:none;">
  <h2>候補者一覧</h2>
  <div id="candidateList"></div>

  <h2>立候補申請</h2>
  <input type="text" id="policy" placeholder="公約を入力">
  <button onclick="registerCandidate()">申請</button>
</div>

<script>
let residentId = "";

function login() {
  const input = document.getElementById("residentIdInput").value.trim();
  if(!input) return alert("住民番号を入力してください");

  db.ref("residents/"+input).once("value", snap=>{
    if(!snap.exists()) return alert("住民番号が存在しません");
    const user = snap.val();
    if(user.points<=0) return alert("ポイント0の住民は投票できません");
    residentId = input;
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("voteDiv").style.display="block";
    loadCandidates();
  });
}

function loadCandidates() {
  const list = document.getElementById("candidateList");
  db.ref("votes/"+residentId).once("value", voteSnap=>{
    if(voteSnap.exists()){
      const votedId = voteSnap.val();
      db.ref("candidates/"+votedId).once("value", cSnap=>{
        const c=cSnap.val();
        list.innerHTML=`<p>あなたは <b>${c.name}</b> に投票しました。公約: ${c.policy}</p>`;
      });
    } else {
      db.ref("candidates").once("value", snap=>{
        list.innerHTML="";
        snap.forEach(child=>{
          const data=child.val();
          list.innerHTML+=`<div class="candidate"><b>${data.name}</b><br>公約:${data.policy}<br><button onclick="vote('${child.key}')">投票</button></div>`;
        });
      });
    }
  });
}

function vote(candidateId){
  db.ref("votes/"+residentId).once("value", snap=>{
    if(snap.exists()) return alert("すでに投票済みです");
    db.ref("votes/"+residentId).set(candidateId);
    db.ref("candidates/"+candidateId+"/votes").transaction(v=> (v||0)+1);
    alert("投票完了しました");
    loadCandidates();
  });
}

function registerCandidate(){
  const policy=document.getElementById("policy").value.trim();
  if(!policy) return alert("公約を入力してください");
  db.ref("residents/"+residentId).once("value", snap=>{
    const user = snap.val();
    const newKey = db.ref("candidates_pending").push().key;
    db.ref("candidates_pending/"+newKey).set({
      residentId: residentId,
      name: user.discordName,
      policy: policy,
      status: "pending"
    });
    alert("立候補申請を送信しました。管理者の承認をお待ちください。");
  });
}
</script>
</body>
</html>
