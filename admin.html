<!DOCTYPE html>
<html lang="ja">
<head>
  <title>篠山県役所 - 管理者画面</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="firebase.js"></script>
</head>
<body>
  <h1>篠山県役所：管理者パネル</h1>

  <!-- ログインフォーム -->
  <div id="loginForm">
    <label for="adminPin">管理者PIN</label>
    <input type="password" id="adminPin" placeholder="4桁のPIN" required>
    <button onclick="verifyPin()">ログイン</button>
  </div>

  <!-- メイン画面 -->
  <div id="adminPanel" style="display:none;">
    <h2>住民一覧</h2>
    <table id="residentTable">
      <thead>
        <tr>
          <th>住民番号</th>
          <th>Discord名</th>
          <th>MCID</th>
          <th>ポイント</th>
          <th>免許</th>
          <th>変更</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const correctPin = "0655"; // 初期PIN（必要に応じて変更可）

    function verifyPin() {
      const input = document.getElementById("adminPin").value;
      if (input === correctPin) {
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        loadResidents();
      } else {
        alert("PINが違います。");
      }
    }

    function getLicense(points) {
      if (points >= 20) return "ネザライト（職員）";
      if (points >= 16) return "ダイヤ（OP）";
      if (points >= 13) return "金（公共交通）";
      if (points >= 10) return "鉄（会社設立）";
      if (points >= 9)  return "銅（クリエ）";
      if (points >= 6)  return "石（就職）";
      if (points >= 3)  return "木（入国）";
      return "免停（BAN）";
    }

    function loadResidents() {
      const tbody = document.querySelector("#residentTable tbody");
      tbody.innerHTML = ""; // 初期化

      db.ref("residents").once("value", snapshot => {
        snapshot.forEach(child => {
          const id = child.key;
          const data = child.val();

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${id}</td>
            <td>${data.discordName}</td>
            <td>${data.mcid}</td>
            <td><input type="number" value="${data.points}" min="0" id="points-${id}" style="width:60px;"></td>
            <td id="license-${id}">${data.license}</td>
            <td><button onclick="updatePoints('${id}')">更新</button></td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    function updatePoints(id) {
      const pointInput = document.getElementById(`points-${id}`);
      const newPoints = parseInt(pointInput.value);
      const newLicense = getLicense(newPoints);

      db.ref("residents/" + id).update({
        points: newPoints,
        license: newLicense
      });

      document.getElementById(`license-${id}`).textContent = newLicense;
      alert("ポイントを更新しました。");
    }
  </script>
</body>
</html>
