<!DOCTYPE html>
<html lang="ja">
<head>

  <title>篠山県役所 - 管理画面</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body {
      font-family: 'Yu Gothic', sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background-color: #003366;
      color: white;
      padding: 15px 0;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 90%;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #005bac;
      color: white;
    }
    input[type="number"] {
      text-align: center;
    }
    button {
      padding: 5px 10px;
      background-color: #005bac;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button[disabled] {
      background-color: #999;
      cursor: not-allowed;
    }
    #loginForm {
      margin-top: 100px;
    }
  </style>
</head>
<body>
<header>
  <h1>篠山県役所 管理画面</h1>
</header>

<div id="loginForm">
  <p>PINまたはパスワードを入力してください</p>
  <input type="password" id="adminPin" placeholder="管理者PIN または 共同管理者パス">
  <button onclick="verifyPin()">ログイン</button>
</div>

<div id="adminPanel" style="display:none;">
  <h2>住民一覧</h2>
  <table id="residentTable">
    <thead>
      <tr>
        <th>住民番号</th>
        <th>Discord名</th>
        <th>MCID</th>
        <th>ポイント</th>
        <th>免許</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="firebase.js"></script>
<script>
  const correctPin = "0655";       // 管理者用PIN
  const coManagerPass = "milk2025"; // 共同管理者用パス
  let userRole = ""; // "admin" or "coManager"

  function verifyPin() {
    const input = document.getElementById("adminPin").value;
    if (input === correctPin) {
      userRole = "admin";
      showPanel();
    } else if (input === coManagerPass) {
      userRole = "coManager";
      showPanel();
    } else {
      alert("PINまたはパスワードが違います。");
    }
  }

  function showPanel() {
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    loadResidents();
  }

  function loadResidents() {
    const tbody = document.querySelector("#residentTable tbody");
    tbody.innerHTML = "";

    db.ref("residents").once("value", snapshot => {
      snapshot.forEach(child => {
        const id = child.key;
        const data = child.val();

        let updateBtn = `<button onclick="updatePoints('${id}')">更新</button>`;
        if (userRole === "coManager") {
          updateBtn = `<button disabled>更新不可</button>`;
        }

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${id}</td>
          <td>${data.discordName}</td>
          <td>${data.mcid}</td>
          <td>
            <input type="number" value="${data.points}" min="0" id="points-${id}" style="width:60px;" ${userRole === "coManager" ? "disabled" : ""}>
          </td>
          <td id="license-${id}">${data.license}</td>
          <td>${updateBtn}</td>
        `;
        tbody.appendChild(row);
      });
    });
  }

  function updatePoints(id) {
    const points = parseInt(document.getElementById(`points-${id}`).value, 10);
    const license = getLicense(points);
    db.ref("residents/" + id).update({ points: points, license: license });
    document.getElementById(`license-${id}`).textContent = license;
    alert("更新しました");
  }

  function getLicense(points) {
    if (points >= 20) return "ネザライト（職員）";
    if (points >= 16) return "ダイヤ（OP）";
    if (points >= 13) return "金（公共交通機関）";
    if (points >= 10) return "鉄（会社設立）";
    if (points >= 9)  return "銅（クリエ）";
    if (points >= 6)  return "石（就職可）";
    if (points >= 3)  return "木（入場可）";
    return "免停（BAN）";
  }
</script>
</body>
</html>
