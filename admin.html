<!DOCTYPE html>
<html lang="ja">
<head>
<title>ç®¡ç†è€…ç”»é¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="firebase.js"></script>
</head>
<body>
<header><h1>ç®¡ç†è€…ç”»é¢</h1></header>
<div class="container section">
  <h2>ä½æ°‘ä¸€è¦§</h2>
  <div id="residentList"></div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const role = urlParams.get('role') || 'coManager';
const password = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

if((role==="admin" && password!=="0655") || (role==="coManager" && password!=="milk2025")) {
  alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
  location.href="index.html";
}

// é‹å–¶ãƒã‚§ãƒƒã‚¯
function toggleAdminCheck(id){
  db.ref("residents/"+id+"/adminCheck").once("value").then(snap=>{
    const val = snap.val() ? false : true;
    db.ref("residents/"+id+"/adminCheck").set(val);
    // ç«‹å€™è£œãƒãƒ¼ã‚¯ã‚’å‰Šé™¤
    if(val) db.ref("residents/"+id+"/candidate").set(false);
    loadResidents();
  });
}

// è·å“¡ãƒã‚§ãƒƒã‚¯
function toggleStaffCheck(id){
  db.ref("residents/"+id+"/staffCheck").once("value").then(snap=>{
    const val = snap.val() ? false : true;
    db.ref("residents/"+id+"/staffCheck").set(val);
    // ç«‹å€™è£œãƒãƒ¼ã‚¯ã‚’å‰Šé™¤
    if(val) db.ref("residents/"+id+"/candidate").set(false);
    loadResidents();
  });
}

function loadResidents(){
  db.ref("residents").once("value", snap=>{
    const list = document.getElementById("residentList");
    list.innerHTML="";
    snap.forEach(child=>{
      const r = child.val();

      // ãƒã‚¤ãƒ³ãƒˆã«ã‚ˆã‚‹å…è¨±
      let license="å…åœ";
      if(r.points>=3) license="æœ¨";
      if(r.points>=6) license="çŸ³";
      if(r.points>=9) license="éŠ…";
      if(r.points>=10) license="é‰„";
      if(r.points>=13) license="é‡‘";
      if(r.points>=16) license="ãƒ€ã‚¤ãƒ¤";
      if(r.points>=20) license="ãƒã‚¶ãƒ©ã‚¤ãƒˆ";

      // ãƒãƒ¼ã‚¯åˆ¤å®š
      let mark = "";
      if(r.staffCheck) mark = "âš’";
      else if(r.adminCheck) mark = "ğŸ”";
      else if(r.candidate) mark = (r.points>=20 && r.points<=29) ? "ğŸ«" : "";

      let html=`<div><b>${r.discordName}${mark}</b> (${r.mcid}) - ä½æ°‘ç•ªå·: ${child.key} - ãƒã‚¤ãƒ³ãƒˆ: <input type="number" value="${r.points}" id="points_${child.key}" style="width:50px"> - å…è¨±: ${license}`;

      if(role==="admin"){
        html+=` <button onclick="updatePoints('${child.key}')">æ›´æ–°</button>`;
        if(r.points>=20 && r.points<=29) html+=` <button onclick="toggleAdminCheck('${child.key}')">é‹å–¶âœ”</button>`;
        if(r.points>=20) html+=` <button onclick="toggleStaffCheck('${child.key}')">è·å“¡âœ”</button>`;
      }

      html+="</div>";
      list.innerHTML+=html;
    });
  });
}

function updatePoints(id){
  const val = parseInt(document.getElementById("points_"+id).value);
  if(isNaN(val)) return alert("æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  db.ref("residents/"+id+"/points").set(val);

  // ãƒã‚¤ãƒ³ãƒˆ20ã€œ29ã§ç«‹å€™è£œåˆæœŸåŒ–
  if(val>=20 && val<=29){
    db.ref("residents/"+id+"/candidate").set(true);
  } else {
    db.ref("residents/"+id+"/candidate").set(false);
  }

  loadResidents();
}

loadResidents();
</script>
</body>
</html>
