<!DOCTYPE html>
<html lang="ja">
<head>
<title>管理者画面</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="firebase.js"></script>
<style>
table { width: 100%; border-collapse: collapse; margin-top:20px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background-color:#003366; color:white; }
button { padding:3px 6px; margin:2px; }
input[type=number] { width:60px; text-align:center; }
</style>
</head>
<body>
<header><h1>管理者画面</h1></header>
<div class="container section">
  <h2>住民一覧（表形式）</h2>
  <table id="residentTable">
    <thead>
      <tr>
        <th>住民番号</th>
        <th>名前</th>
        <th>MCID</th>
        <th>ポイント</th>
        <th>免許</th>
        <th>マーク</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const role = urlParams.get('role') || 'coManager';
const password = prompt("パスワードを入力してください");

if((role==="admin" && password!=="0655") || (role==="coManager" && password!=="milk2025")) {
  alert("パスワードが違います");
  location.href="index.html";
}

function toggleAdminCheck(id){
  db.ref("residents/"+id+"/adminCheck").once("value").then(snap=>{
    const val = snap.val() ? false : true;
    db.ref("residents/"+id+"/adminCheck").set(val);
    if(val) db.ref("residents/"+id+"/candidate").set(false);
    loadResidents();
  });
}

function toggleStaffCheck(id){
  db.ref("residents/"+id+"/staffCheck").once("value").then(snap=>{
    const val = snap.val() ? false : true;
    db.ref("residents/"+id+"/staffCheck").set(val);
    if(val) db.ref("residents/"+id+"/candidate").set(false);
    loadResidents();
  });
}

function loadResidents(){
  db.ref("residents").once("value", snap=>{
    const tbody = document.querySelector("#residentTable tbody");
    tbody.innerHTML="";
    snap.forEach(child=>{
      const r = child.val();

      // 免許判定
      let license="免停";
      if(r.points>=3) license="木";
      if(r.points>=6) license="石";
      if(r.points>=9) license="銅";
      if(r.points>=10) license="鉄";
      if(r.points>=13) license="金";
      if(r.points>=16) license="ダイヤ";
      if(r.points>=20) license="ネザライト";

      // マーク判定
      let mark = "";
      if(r.staffCheck) mark = "⚒";
      else if(r.adminCheck) mark = "🔐";
      else if(r.candidate) mark = (r.points>=20 && r.points<=29) ? "🎫" : "";

      // 行生成
      let row = document.createElement("tr");
      row.innerHTML = `
        <td>${child.key}</td>
        <td>${r.discordName}</td>
        <td>${r.mcid}</td>
        <td><input type="number" id="points_${child.key}" value="${r.points}"></td>
        <td>${license}</td>
        <td>${mark}</td>
        <td>
          ${role==="admin" ? `<button onclick="updatePoints('${child.key}')">更新</button>` : ""}
          ${role==="admin" && r.points>=20 && r.points<=29 ? `<button onclick="toggleAdminCheck('${child.key}')">運営✔</button>` : ""}
          ${role==="admin" && r.points>=20 ? `<button onclick="toggleStaffCheck('${child.key}')">職員✔</button>` : ""}
        </td>
      `;
      tbody.appendChild(row);
    });
  });
}

function updatePoints(id){
  const val = parseInt(document.getElementById("points_"+id).value);
  if(isNaN(val)) return alert("数字を入力してください");
  db.ref("residents/"+id+"/points").set(val);

  if(val>=20 && val<=29){
    db.ref("residents/"+id+"/candidate").set(true);
  } else {
    db.ref("residents/"+id+"/candidate").set(false);
  }

  loadResidents();
}

loadResidents();
</script>
</body>
</html>
