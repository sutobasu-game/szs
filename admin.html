<!DOCTYPE html>
<html lang="ja">
<head>
<title>ç®¡ç†è€…ç”»é¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="firebase.js"></script>
<style>
table { width: 100%; border-collapse: collapse; margin-top:20px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background-color:#003366; color:white; }
button { padding:3px 6px; margin:2px; }
input[type=number] { width:60px; text-align:center; }
</style>
</head>
<body>
<header><h1>ç®¡ç†è€…ç”»é¢</h1></header>
<div class="container section">
  <h2>ä½æ°‘ä¸€è¦§ï¼ˆè¡¨å½¢å¼ï¼‰</h2>
  <table id="residentTable">
    <thead>
      <tr>
        <th>ä½æ°‘ç•ªå·</th>
        <th>åå‰</th>
        <th>MCID</th>
        <th>ãƒã‚¤ãƒ³ãƒˆ</th>
        <th>å…è¨±</th>
        <th>ãƒãƒ¼ã‚¯</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const role = urlParams.get('role') || 'coManager';
const password = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

if((role==="admin" && password!=="0655") || (role==="coManager" && password!=="milk2025")) {
  alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
  location.href="index.html";
}

function toggleAdminCheck(id){
  db.ref("residents/"+id+"/adminCheck").once("value").then(snap=>{
    const val = snap.val() ? false : true;
    db.ref("residents/"+id+"/adminCheck").set(val);
    if(val) db.ref("residents/"+id+"/candidate").set(false);
    loadResidents();
  });
}

function toggleStaffCheck(id){
  db.ref("residents/"+id+"/staffCheck").once("value").then(snap=>{
    const val = snap.val() ? false : true;
    db.ref("residents/"+id+"/staffCheck").set(val);
    if(val) db.ref("residents/"+id+"/candidate").set(false);
    loadResidents();
  });
}

function loadResidents(){
  db.ref("residents").once("value", snap=>{
    const tbody = document.querySelector("#residentTable tbody");
    tbody.innerHTML="";
    snap.forEach(child=>{
      const r = child.val();

      // å…è¨±åˆ¤å®š
      let license="å…åœ";
      if(r.points>=3) license="æœ¨";
      if(r.points>=6) license="çŸ³";
      if(r.points>=9) license="éŠ…";
      if(r.points>=10) license="é‰„";
      if(r.points>=13) license="é‡‘";
      if(r.points>=16) license="ãƒ€ã‚¤ãƒ¤";
      if(r.points>=20) license="ãƒã‚¶ãƒ©ã‚¤ãƒˆ";

      // ãƒãƒ¼ã‚¯åˆ¤å®š
      let mark = "";
      if(r.staffCheck) mark = "âš’";
      else if(r.adminCheck) mark = "ğŸ”";
      else if(r.candidate) mark = (r.points>=20 && r.points<=29) ? "ğŸ«" : "";

      // è¡Œç”Ÿæˆ
      let row = document.createElement("tr");
      row.innerHTML = `
        <td>${child.key}</td>
        <td>${r.discordName}</td>
        <td>${r.mcid}</td>
        <td><input type="number" id="points_${child.key}" value="${r.points}"></td>
        <td>${license}</td>
        <td>${mark}</td>
        <td>
          ${role==="admin" ? `<button onclick="updatePoints('${child.key}')">æ›´æ–°</button>` : ""}
          ${role==="admin" && r.points>=20 && r.points<=29 ? `<button onclick="toggleAdminCheck('${child.key}')">é‹å–¶âœ”</button>` : ""}
          ${role==="admin" && r.points>=20 ? `<button onclick="toggleStaffCheck('${child.key}')">è·å“¡âœ”</button>` : ""}
        </td>
      `;
      tbody.appendChild(row);
    });
  });
}

function updatePoints(id){
  const val = parseInt(document.getElementById("points_"+id).value);
  if(isNaN(val)) return alert("æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  db.ref("residents/"+id+"/points").set(val);

  if(val>=20 && val<=29){
    db.ref("residents/"+id+"/candidate").set(true);
  } else {
    db.ref("residents/"+id+"/candidate").set(false);
  }

  loadResidents();
}

loadResidents();
</script>
</body>
</html>
